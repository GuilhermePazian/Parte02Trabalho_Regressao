---
title: "trabalho Regressão parte 02"
date: "6 de dezembro de 2016"
output: pdf_document
---

```{r pacotes,eval=FALSE,echo=FALSE}
#eval= FALSE faz com que o R ignore este chunk
#echo = FALSE não permite que o chunk apareça no pdf

pacotes = c("tidyverse","plyr","dplyr","reshape2","knitr")
install.packages(pacotes)
```


```{r Funcoes,echo=FALSE}
#echo = FALSE não permite que o chunk apareça no pdf



#Função que produz os quatro gráficos para a análise de resíduos



diag2norm<-function(fit.model){
# fit.model: objeto com o ajuste do modelo normal linear homocedástico 
# obtido através da função "lm"

par(mfrow=c(2,2))
X <- model.matrix(fit.model)
n <- nrow(X)
p <- ncol(X)
H <- X%*%solve(t(X)%*%X)%*%t(X)
h <- diag(H)
lms <- summary(fit.model)
s <- lms$sigma
r <- resid(lms)
ts <- r/(s*sqrt(1-h))
di <- (1/p)*(h/(1-h))*(ts^2)
si <- lm.influence(fit.model)$sigma
tsi <- r/(si*sqrt(1-h))
a <- max(tsi)
b <- min(tsi)
par(mfrow=c(2,2))
#
plot(tsi,xlab="Índice", ylab="Resíduo Studentizado",
ylim=c(b-1,a+1), pch=16,cex=1.1,cex.axis=1.1,cex.lab=1.1)
abline(2,0,lty=2)
abline(-2,0,lty=2)
abline(0,0,lty=2)
#identify(tsi, n=1)
#title(sub="(c)")
#
plot(fitted(fit.model),tsi,xlab="Valores Ajustados", 
ylab="Resíduo Studentizado", ylim=c(b-1,a+1), pch=16,cex=1.1,cex.axis=1.1,cex.lab=1.1)
#
abline(2,0,lty=2)
abline(-2,0,lty=2)
abline(0,0,lty=2)
#boxplot(tsi,ylab="Resíduo Studentizado",cex=1.1,cex.axis=1.1,cex.lab=1.1)
hist(tsi,xlab="Resíduo Studentizado",ylab="densidade",probability=TRUE,main="",cex=1.1,cex.axis=1.1,cex.lab=1.1)
#title(sub="(d)")
#identify(fitted(fit.model),tsi, n=1)
#
boxplot(tsi,ylab="Resíduo Studentizado",cex=1.1,cex.axis=1.1,cex.lab=1.1)

#---------------------------------------------------------------#
}





#função para fazer o gráfico de envelopes




envelnorm<-function(fit.model){
# fit.model: objeto com o ajuste do modelo normal linear homocedástico 
# obtido através da função "lm"

#par(mfrow=c(1,1))
X <- model.matrix(fit.model)
n <- nrow(X)
p <- ncol(X)
H <- X%*%solve(t(X)%*%X)%*%t(X)
h <- diag(H)
si <- lm.influence(fit.model)$sigma
r <- resid(fit.model)
tsi <- r/(si*sqrt(1-h))
#
ident <- diag(n)
epsilon <- matrix(0,n,100)
e <- matrix(0,n,100)
e1 <- numeric(n)
e2 <- numeric(n)
#
for(i in 1:100){
     epsilon[,i] <- rnorm(n,0,1)
     e[,i] <- (ident - H)%*%epsilon[,i]
     u <- diag(ident - H)
     e[,i] <- e[,i]/sqrt(u)
     e[,i] <- sort(e[,i]) }
#
for(i in 1:n){
     eo <- sort(e[i,])
     e1[i] <- (eo[2]+eo[3])/2
     e2[i] <- (eo[97]+eo[98])/2 }
#
med <- apply(e,1,mean)
faixa <- range(tsi,e1,e2)
#
#par(pty="s")
qqnorm(tsi,xlab="Percentil da N(0,1)",
ylab="Residuo Studentizado", ylim=faixa, pch=16, main="",cex=1.1,cex.axis=1.1,cex.lab=1.1)
par(new=T)
qqnorm(e1,axes=F,xlab="",ylab="",type="l",ylim=faixa,lty=1, main="")
par(new=T)
qqnorm(e2,axes=F,xlab="",ylab="", type="l",ylim=faixa,lty=1, main="")
par(new=T)
qqnorm(med,axes=F,xlab="",ylab="",type="l",ylim=faixa,lty=2, main="")
#------------------------------------------------------------#
}




#função para "medidas de influência e alavancagem"




anainflu_norm<-function(fit.model){
# fit.model: objeto com o ajuste do modelo normal linear homocedástico 
# obtido através da função "lm"
X <- model.matrix(fit.model)
n <- nrow(X)
p <- ncol(X)
H <- X%*%solve(t(X)%*%X)%*%t(X)
h <- diag(H)
lms <- summary(fit.model)
s <- lms$sigma
r <- resid(lms)
ts <- r/(s*sqrt(1-h))
di <- (1/p)*(h/(1-h))*(ts^2)
si <- lm.influence(fit.model)$sigma
tsi <- r/(si*sqrt(1-h))
a <- max(tsi)
b <- min(tsi)
par(mfrow=c(1,2))
plot(h,xlab="Índice", ylab="Medida h", pch=16, ylim=c(0,1),cex=1.1,cex.axis=1.1,cex.lab=1.1)
cut <- 2*p/n
abline(cut,0,lty=2)
#identify(h, n=1)
#title(sub="(a)")
#
plot(di,xlab="Índice", ylab="Distância de Cook", pch=16,cex=1.1,cex.axis=1.1,cex.lab=1.1)
#identify(di, n=2)
#
#------------------------------------------------------------#
}
```

#Introdução

Este presente trabalho é parte do escopo da disciplina ME613 - Regressão Linear e visa a aplicação dos conhecimentos adquiridos em sala de aula. Grande parte do trabalho foi baseado e adaptado a partir dos materiais disponibilizados na página do curso: [http://www.ime.unicamp.br/~cnaber/Material_ME613_2S_2016.htm]("http://www.ime.unicamp.br/~cnaber/Material_ME613_2S_2016.htm").  
O conjunto de dados a ser analisado está disponível em na página do curso sob o nome "reg3.dat". Neste são  descritas as seguintes variáveis referentes a 50 estados norte-americanos: (i) **estado** (nome do estado), (ii) **pop** (população estimada em julho de 1975), (iii) **percap** (renda percapita em 1974 em USD), (iv) **analf** (proporção de analfabetos em 1970), (v) **expvida** (expectativa de vida em anos 1969-70), (vi) **crime** (taxa de criminalidade por 100000 habitantes 1976), (vii) **estud** (porcentagem de estudantes que concluem o segundo grau 1970), (viii) **ndias** (número de dias do ano com temperatura abaixo de zero grau Celsus na cidade mais importante do estado) e (ix) **area** (área do estado em milhas quadradas). O objetivo do estudo é tentar explicar a variável **expvida** usando um modelo de regressão normal linear dadas as variáveis explicativas **percap**, **analf**, **crime**, **estud**, **ndias** e **dens**, em que **dens**=pop/area (densidade da população estimada em julho de 1975 por área do estado em milhas quadradas).  
Todos os modelos neste trabalho foram ajustados via metodologia de mínimos quadrados ordinários, veja Azevedo (2016), e todas suas respectivas análises residuais foram realizadas, conforme Paula (2013).
A menos que seja citado o contrário, todas as variáveis que constam na base de dados serão referidas por sua descrição completa ou pelo nome que consta no banco de dados (estes foram supracitados em negrito). Denotaremos também:
  
$Y_i$ - i-ésima observação da variável expvida  
$x_{1i}$ - i-esima observação da variável percap  
$x_{2i}$ - i-esima observação da variável analf  
$x_{3i}$ - i-esima observação da variável crime  
$x_{4i}$ - i-esima observação da variável estud  
$x_{5i}$ - i-esima observação da variável ndias  
$x_{6i}$ - i-esima observação da variável dens  



```{r leitura,echo = FALSE}
#echo = FALSE não permite que o chunk apareça no pdf
library(plyr)
library(tidyverse)
library(dplyr)

#leitura dos dados

dados = read.table("http://www.ime.unicamp.br/~cnaber/reg3.dat")
names(dados)=c("Estado","pop","percap","analf","expvida","crime","estud","ndias","area")

#criação variável dens
dados = dados %>% mutate(dens=pop/area)

#seleção das variáveis segundo orientação do Caio
dados = dados %>% select(percap, analf, crime, estud, ndias,dens,expvida)
```

#2.Análise Descritiva

```{r descritivas,echo = FALSE}
#echo = FALSE não permite que o chunk apareça no pdf

library(reshape2)
library(printr)

#manipulação dos dados

estat_desc <- dados
estat_desc$Estado = NULL

df <- melt(estat_desc, id.vars = 0)

#tabela resumo

resumo <- ddply(df, c("variable"), function(x) summary(x$value))
#arredondando os valores !!! tentar arredondar os decimais porem manter os discretos com somente o valor!!!
resumo[,2:ncol(resumo)] <- round(resumo[,2:ncol(resumo)],4)
resumo
```


```{r boxplots,echo = FALSE,eval=FALSE}
#echo = FALSE não permite que o chunk apareça no pdf
#eval= FALSE faz com que o R ignore este chunk

# !!!acho que boxplots não são nescessários neste caso, já que temos todas as variáveis contínuas (ou discretas), ou seja, nenhum fator!!!

#boxplots
ggplot(df, aes(x = variable, y =  value)) +
  geom_boxplot() +
  facet_wrap(~variable, scales = "free") +  theme_bw()
```

Dado a natureza quantitativa dos dados, é de grande interesse que identifiquemos as relações entre as covariáveis explicativas e a variável resposta, a fim de tornar essas relações visuais, foi construido graficos de dispersão entre a variável resposta e entre todas as covariáveis de interesse. Estes estão representados na figura XX. 

```{r dispersao,echo = FALSE}
#echo = FALSE não permite que o chunk apareça no pdf

#gráficos de dispersão
dispersao <- melt(estat_desc, id.vars = 7)
ggplot(dispersao, aes(x = value, y =  expvida)) +
  geom_point() +
  facet_wrap(~variable, scales = "free") +  theme_bw()
```

A partir da FiguraXX, podemos identificar visualmente a relação supracitada, a qual identificamos que todas as covariáveis parecem ter uma relação linear significativa, as quais existem relações lineares negativas entre a variável resposta e as covariáveis "analf" e "crime", assim como relações lineares negativas entre a variável resposta "expvida" e as covariáveis "percap","estud","ndias" e "dens" (a menos a um ponto).



#Análise Inferêncial


```{r padronizacao,echo = FALSE}
#echo = FALSE não permite que o chunk apareça no pdf


#Padronizacao dos dados
dados[,c(1:ncol(dados))] =  sapply(dados[,c(1:ncol(dados))], function(x) (x-mean(x))/sd(x))

```

Dada a constatação visual de relações lineares entre a variável resposta "expvida" e todas as covariáveis explicativas, é razoável iniciar um modelo que contemple todas estas covariáveis. Visando poder comparar diretamente os coeficiêntes do modelo, optamos por introduzir as covariáveis com médias e variâncias iguais, tornardo-as adimensionais. Portanto, vamos iniciar a análise com o seguinte modelo:

Modelo: !!!note que pode-se resumir a interpretação de $B_j/s_j$ caso precise de espeço!!!
$$
Y_i = \beta_0 + \sum_{j=1}^{6}\beta_j \left (\frac{x_{ji}-\bar{x_j}}{s_j}   \right ) + \varepsilon_{i}\left\{\begin{matrix}
i= 1,\dots,50 \\ 
j=  1,\dots,6
\end{matrix}\right.
$$
em que  $\varepsilon_{i} \overset{i.i.d.}{\sim} N(0,\sigma^2)$ , $x_j=\frac{1}{50}\sum_{i=1}^{50}x_ji$ e  $s_j=\sqrt{\frac{1}{50}\sum_{i=1}^{50}(x_{ji}-\bar{x_j})^2}$

$Y_i$ : Expectativa de vida em anos (1969-70).  
$\beta_0$ : Expectativa de vida esperada em anos (1969-70) para valores de covariáveis iguais às suas respectivas médias.  
$\frac{\beta_1}{s_1}$ : Incremento (positivo ou negativo) na expectativa de vida em anos (1969-70) esperada quando se aumenta o valor da "renda percapita (em 1974 em USD)" em uma unidade, mantendo-se as demais covariáveis fixas.  
$\frac{\beta_2}{s_2}$ : Incremento (positivo ou negativo) na expectativa de vida em anos (1969-70) esperada quando se aumenta o valor da "proporção de analfabetos (em 1970)" em uma unidade, mantendo-se as demais covariáveis fixas.  
$\frac{\beta_3}{s_3}$ : Incremento (positivo ou negativo) na expectativa de vida em anos (1969-70) esperada quando se aumenta o valor da "taxa de criminalidade (por 100000 habitantes 1976)" em uma unidade, mantendo-se as demais covariáveis fixas.  
$\frac{\beta_4}{s_4}$ : Incremento (positivo ou negativo) na expectativa de vida em anos (1969-70) esperada quando se aumenta o valor da "porcentagem
de estudantes que concluem o segundo grau (1970)" em uma unidade, mantendo-se as demais covariáveis fixas.  
$\frac{\beta_5}{s_5}$ : Incremento (positivo ou negativo) na expectativa de vida em anos (1969-70) esperada quando se aumenta o valor de "número de dias do ano com temperatura abaixo de zero grau Celsus na cidade mais importante do estado" em uma unidade, mantendo-se as demais covariáveis fixas.  
$\frac{\beta_6}{s_6}$ : Incremento (positivo ou negativo) na expectativa de vida em anos (1969-70) esperada quando se aumenta o valor da "densidade da população estimada em julho de 1975 por área do estado em milhas quadradas" em uma unidade, mantendo-se as demais covariáveis fixas.  

```{r modelo completo,echo = FALSE}
#echo = FALSE não permite que o chunk apareça no pdf

#modelo padronizado completo
fitmax <- lm(expvida~percap+analf+crime+estud+ndias+dens,data=dados)
```
Pode-se observar a partir das figuras XX e XX que o modelo não teve um ajuste adequado, uma vez que se é possível observar uma assimetria positiva no histograma apresentado (gráfico YY da figura XX), assim como uma tendencia no gráfico de envelopes (figura XX) o que nos dá indícios de falta de normalidade nos resíduos. **!!!eu não identifiquei heterocedasticidade, se alguem achar que têm, escreva algum argumento!!!**. Neste caso, deveria-se procurar modelos alternativos que levem em consideração uma distribuição assimetrica. Dado o escopo do curso, procede-se com as análises posteriores.




```{r residuos,echo = FALSE}
#echo = FALSE não permite que o chunk apareça no pdf

# !!!acho que seria mais produtivo fazer análise de resíduos apenas para o modelo completo!!!

#grpaficos para análise de resíduos
diag2norm(fitmax)
```

```{r envelope,echo = FALSE}
#echo = FALSE não permite que o chunk apareça no pdf

#gráfico de envelopes
envelnorm(fitmax)
```
Note, pela tabela XX que somente os parêmetros relacionados às covariáveis "crime", "ndias" e "dens" significativos à um nível de significancia =0,10. A partir desse resultado, temos a indicação de que um modelo reduzido pode ser mais apropriado. Contudo, desejamos também, obter o modelo que melhor se ajusta aos dados.

```{r}
#pacote para produzir tabela em latex
library(knitr)

# !!! depois editar!!!
#coeficientes e R^2 e R^2 ajustado
R2fitmax <- summary(fitmax)$r.squared
R2fitmax
R2aj_fitmax <- summary(fitmax)$adj.r.squared
R2aj_fitmax
kable(summary(fitmax)$coefficients)

```

#Seleção dos modelos
A técnica escolhida para nos auxiliar a selecionar o modelo normal linear homocedastico que melhor se ajusta aos dados foi a técnica stepwise, veja Azevedo (2016).

```{r modelo intercepto,echo = FALSE}
#echo = FALSE não permite que o chunk apareça no pdf

#modelo padronizado só com o intercepto
fitmin <- lm(expvida~1,data = dados)
```

```{r stepwisemin,echo = FALSE,eval=TRUE}
#echo = FALSE não permite que o chunk apareça no pdf

#seleção stepwise começando do modelo min (modelo só com o intercepto)
step_min <- step(fitmin,scope = list(upper=fitmax),direction = "both")
```



```{r stepwisemax,echo = FALSE,eval=TRUE}
#echo = FALSE não permite que o chunk apareça no pdf


#seleção stepwise começando do modelo max (modelo com todas as variaveis explicativas)
step_max <- step(fitmax,scope = list(lower=fitmin),direction = "both")
```


A aplicação da metodologia stepwise, començando com o modelo só
com o intercepto ou começando com o modelo completo, indicou,
em ambos os casos que o modelo com que melhor se ajusta é o modelo que leva em consideração somente as covariáveis "crime","estud","ndias" e "dens".

Temos agora o seguinte modelo:

$$
Y_i = \beta_0 + \sum_{j=3}^{6}\beta_j \left (\frac{x_{ji}-\bar{x_j}}{s_j}   \right ) + \varepsilon_{i}\left\{\begin{matrix}
i= 1,\dots,50 \\ 
j=  3,\dots,6
\end{matrix}\right.
$$
em que  $\varepsilon_{i} \overset{i.i.d.}{\sim} N(0,\sigma^2)$ , $x_j=\frac{1}{50}\sum_{i=1}^{50}x_ji$ e  $s_j=\sqrt{\frac{1}{50}\sum_{i=1}^{50}(x_{ji}-\bar{x_j})^2}$

$Y_i$ : Expectativa de vida em anos (1969-70).  
$\beta_0$ : Expectativa de vida esperada em anos (1969-70) para valores de covariáveis iguais às suas respectivas médias.  
$\frac{\beta_3}{s_3}$ : Incremento (positivo ou negativo) na expectativa de vida em anos (1969-70) esperada quando se aumenta o valor da "taxa de criminalidade (por 100000 habitantes 1976)" em uma unidade, mantendo-se as demais covariáveis fixas.  
$\frac{\beta_4}{s_4}$ : Incremento (positivo ou negativo) na expectativa de vida em anos (1969-70) esperada quando se aumenta o valor da "porcentagem de estudantes que concluem o segundo grau (1970)" em uma unidade, mantendo-se as demais covariáveis fixas.  
$\frac{\beta_5}{s_5}$ : Incremento (positivo ou negativo) na expectativa de vida em anos (1969-70) esperada quando se aumenta o valor de "número de dias do ano com temperatura abaixo de zero grau Celsus na cidade mais importante do estado" em uma unidade, mantendo-se as demais covariáveis fixas.  
$\frac{\beta_6}{s_6}$ : Incremento (positivo ou negativo) na expectativa de vida em anos (1969-70) esperada quando se aumenta o valor da "densidade da população estimada em julho de 1975 por área do estado em milhas quadradas" em uma unidade, mantendo-se as demais covariáveis fixas.

```{r Modelo Otimo,echo = FALSE}
#echo = FALSE não permite que o chunk apareça no pdf

#modelo "ótimo" segundo o stepwise

fit_otimo <- lm(expvida ~ crime + estud + ndias + dens, data = dados)
```

Em anuência ao ajuste do modelo anterior, este modelo também não apresentou um ajuste adequado, uma vez que se observa nas figuras YY XX indícios de mal ajuste semelhantes aos observados na análise residual para o modelo anterior. **!!! alguém identificou algum problema a mais??? argumentar aqui!!!** 
Neste caso, deveria-se procurar modelos alternativos que levem em consideração uma distribuição assimetrica. Novamente, dado o escopo do curso, procede-se com as análises posteriores.

```{r residuos modelo otimo,echo = FALSE}
#echo = FALSE não permite que o chunk apareça no pdf

#grpaficos para análise de resíduos
diag2norm(fit_otimo)
```

```{r envelope modelo otimo,echo = FALSE}
#echo = FALSE não permite que o chunk apareça no pdf

#gráfico de envelopes
envelnorm(fit_otimo)
```






```{r}
#coeficientes modelo otimo

#!!!Editar essa tabela!!!

R2fit_otimo <- summary(fit_otimo)$r.squared
R2fit_otimo
R2aj_fit_otimo <- summary(fit_otimo)$adj.r.squared
R2aj_fit_otimo
kable(summary(fit_otimo)$coefficients)
```

#Multicolinearidade

Mesmo o modelo não apresentando muitas covariáveis, é interessante, a fim de assegurar a validade dos resultados obtidos (desconsidere que o modelo não teve um bom ajuste), verificar também a possibilidade de se ter multicolinearidade presente no modelo ajustado. Com o propósito de identificar alguma indicação de multicolinearidade no modelo, podemos análisar os coeficiêntes de corelação linear entre as covariáveis "crime", "estud", "ndias" e "dens". Porém, observamos na tabela XX (abaixo) que nenhum par de covariáveis apresenta coeficiente de correlação deveras alto. Este fato, somado ao fato das covariáveis presentes no medelo não apresentarem nenhum indício de serem fontes de multicolinearidade, descartamos então, a hipótese de presença de multicolinearidade no modelo.


```{r}
#Análise de multicolineariedade descritivamente

#pegando só as variáveis do modelo otimo
dados_modelo_otimo <- dados[,3:6]
cor(dados_modelo_otimo)

```



#Alavancagem

Observando a figura XX podemos identificar a existência de pontos distantes dos demais, o que é uma indicação de ............. **!!!escrever explicaçõs, identificar os pontos e depois ajustar modelos sem estes pontos e compara-los via AIC e BIC!!!**
```{r alavancagem,echo = FALSE}
#echo = FALSE não permite que o chunk apareça no pdf

#medidas de influência e alavancagem

anainflu_norm(fit_otimo)
```

